# Triggering Cloud Build with GSR 

[One detailing how to deploy with Cloud Run in Cloud Build](https://cloud.google.com/build/docs/deploying-builds/deploy-cloud-run)  
[Another one detailing how to trigger Cloud Build with a Cloud Source Repositories repo](https://cloud.google.com/source-repositories/docs/integrating-with-cloud-build)  

In this mix, I will create a simple Cloud Run deployment with Cloud Build, and then set a trigger that will allow the Cloud Build automated steps to be run whenever a push event is generated by a Cloud Source Repository, and apply the changes introduced by the new push to the repo.

## Differences from the quickstarts

- In the first quickstart they use Container Registry which is the antecessor to Artifact Registry. I use Artifact Registry.

## Service accounts

Enable the Cloud Build and Artifact Repositories if you haven't, and make sure the Cloud Build SA is created.

You will need to give the Cloud Build service account the following permissions:  
- Cloud Run Admin (roles/run.admin, without this specific role, the --allow-unauthenticated flag cannot be applied)  
- Service Account User (roles/iam.serviceAccountUser, to impersonate other service accounts)


```
export PROJECT_ID=<yourProjectID>
export PROJECT_NUMBER=<yourProjectNumber>
gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" --role=roles/run.admin
gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" --role=roles/iam.serviceAccountUser

```

## Create a new repo in the GCP Source Repositories 

This command may ask to enable the Source Repositories API.

Create the repo and clone it:
```
gcloud source repos create mybuildsrepo
gcloud source repos clone mybuildsrepo
```

## Running it

In case you don't have Git installed, install it with `sudo apt-get update && sudo apt-get install git`. 

Clone my repo sample files (this is a different repo than the one you just created):
```
git clone https://github.com/thelaser/gcp_snippets.git
```

Copy the files to your repo:
```
cp gcp_snippets/CloudBuild/quickstart3-4-GSR-triggers/* mybuildsrepo
```

Now move into the folder for your repo and push the new files to the Source Repositories repo: 
```
git add *
git commit -m "initial commit"
git push
```
You should not need to setup Git with any credentials, as gcloud should have done it when you did `gcloud clone`.

## Creating the trigger

Before triggering the build you will need to **create a repo in Artifact Registry**, as it must be previosly created. We could configure Cloud Build to create a new repo, but this is not the case here. So make sure your repo already exists and that your reference to it points to the right location etc. I modified the code sample so that it points to the **europe-west1 region**, make sure you create the repo there or that you modify the code, otherwise it won't work.

I will use the CLI command detailed in the [second guide](https://cloud.google.com/source-repositories/docs/integrating-with-cloud-build#create_a_build_trigger)
```
gcloud beta builds triggers create cloud-source-repositories \
    --repo=mybuildsrepo \
    --branch-pattern=master \
    --build-config=cloudbuild.yaml
```

Now go to the folder where you have the files, and modify something, for example change the message in the main.py from `return f"Hello {name}!"` to `return f"Hello, {name}!"`

Push the changes to the repo for the file:
```
git add main.py
git commit -m 'trigger test'
git push
```
You can follow the build in the [Cloud Builds page](https://console.cloud.google.com/cloud-build) in the Console. Or run the corresponding [Cloud SDK CLI command](https://cloud.google.com/sdk/gcloud/reference/builds/log).

If the Cloud Build was successful, you should see the finished build with no errors in the [Cloud Builds page](https://console.cloud.google.com/cloud-build) in the Console, and you should also be able to see a Cloud Run service called `mynginxservice` in the [Cloud Run page](https://console.cloud.google.com/run) in the Console.

This automated build may fail if some of the involved APIs are not enabled, so make sure all are enabled.

For every push you make to the repo, Cloud Build will be triggered and the changes will be reflected in the Cloud Run service.

*NOTE:* In the cloudbuild.yaml file, I use the REPO_NAME variable in the path for the Artifact Registry image, but this variable is populated with the name from the Source Repository repo, therefore, in this scenario both repos have the same name for convenience. In real scenarios the repos may have different names and the usage seen here may not be used. You can check for more info on the Cloud Build variable subs in [here](https://cloud.google.com/build/docs/configuring-builds/substitute-variable-values#using_default_substitutions)

